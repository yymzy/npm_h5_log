{"code":"import { __assign } from \"tslib\";\r\nimport Robot from \"dingtalk-robot-sender\";\r\n/*\r\n *  默认上报的错误信息\r\n */\r\nvar defaults = {\r\n    ua: window.navigator.userAgent,\r\n    browser: getBrowser(),\r\n    os: getDevices(),\r\n    osVersion: getSystemVersion(),\r\n    errUrl: window.location.href,\r\n    msg: \"\",\r\n    url: \"\",\r\n    line: \"\",\r\n    col: \"\",\r\n    error: \"\",\r\n};\r\n/**\r\n *\r\n * @description 获取系统版本\r\n * @returns\r\n */\r\nfunction getSystemVersion() {\r\n    var ua = window.navigator.userAgent;\r\n    if (ua.indexOf(\"CPU iPhone OS \") >= 0) {\r\n        return ua.substring(ua.indexOf(\"CPU iPhone OS \") + 14, ua.indexOf(\" like Mac OS X\"));\r\n    }\r\n    if (ua.indexOf(\"Android \") >= 0) {\r\n        return ua.substr(ua.indexOf(\"Android \") + 8, 3);\r\n    }\r\n    return \"\";\r\n}\r\n/**\r\n   获取浏览器类型\r\n  */\r\nfunction getBrowser() {\r\n    var userAgent = window.navigator.userAgent; // 取得浏览器的userAgent字符串\r\n    var isOpera = userAgent.indexOf(\"Opera\") > -1;\r\n    if (isOpera) {\r\n        return \"Opera\";\r\n    } // 判断是否Opera浏览器\r\n    if (userAgent.indexOf(\"Firefox\") > -1) {\r\n        return \"FF\";\r\n    } // 判断是否Firefox浏览器\r\n    if (userAgent.indexOf(\"Chrome\") > -1) {\r\n        return \"Chrome\";\r\n    }\r\n    if (userAgent.indexOf(\"Safari\") > -1) {\r\n        return \"Safari\";\r\n    } // 判断是否Safari浏览器\r\n    if (userAgent.indexOf(\"compatible\") > -1 &&\r\n        userAgent.indexOf(\"MSIE\") > -1 &&\r\n        !isOpera) {\r\n        return \"IE\";\r\n    } // 判断是否IE浏览器\r\n}\r\n/**\r\n   获取设备是安卓、IOS  还是PC端\r\n  */\r\nfunction getDevices() {\r\n    var u = window.navigator.userAgent;\r\n    if (/AppleWebKit.*Mobile/i.test(window.navigator.userAgent) ||\r\n        /MIDP|SymbianOS|NOKIA|SAMSUNG|LG|NEC|TCL|Alcatel|BIRD|DBTEL|Dopod|PHILIPS|HAIER|LENOVO|MOT-|Nokia|SonyEricsson|SIE-|Amoi|ZTE/.test(window.navigator.userAgent)) {\r\n        if (window.location.href.indexOf(\"?mobile\") < 0) {\r\n            try {\r\n                if (/iPhone|mac|iPod|iPad/i.test(window.navigator.userAgent)) {\r\n                    return \"iPhone\";\r\n                }\r\n                else {\r\n                    return \"Android\";\r\n                }\r\n            }\r\n            catch (e) { }\r\n        }\r\n    }\r\n    if (u.indexOf(\"iPad\") > -1) {\r\n        return \"iPhone\";\r\n    }\r\n    return \"Android\";\r\n}\r\nfunction Markdown() {\r\n    this.text = '';\r\n    this.title = '';\r\n    this.items = [];\r\n    this.setTitle = function (title) {\r\n        this.title = title;\r\n        return this;\r\n    };\r\n    this.add = function (text) {\r\n        if (Array.isArray(text)) {\r\n            this.items.concat(text);\r\n        }\r\n        else {\r\n            this.items.push(text);\r\n        }\r\n        this.text = this.items.join('\\n');\r\n        return this;\r\n    };\r\n}\r\nfunction ddNotice(params, reportData) {\r\n    return new Promise(function (resolve, reject) {\r\n        // 钉钉机器人群通知\r\n        var ddIns = new Robot(__assign({ baseUrl: \"https://oapi.dingtalk.com/robot/send\" }, params));\r\n        var content = new Markdown()\r\n            .setTitle('markdownTitle')\r\n            .add(\"\" + JSON.stringify(reportData));\r\n        ddIns.markdown(content.title, content.text)\r\n            .then(resolve)\r\n            .catch(reject);\r\n    });\r\n}\r\n/**\r\n *\r\n * @description 触发上报\r\n * @param reportData\r\n * @param params\r\n */\r\nfunction report(reportData, params) {\r\n    if (params.dd) {\r\n        ddNotice(params.dd, reportData)\r\n            .then(params.success)\r\n            .catch(params.fail);\r\n    }\r\n}\r\n/**\r\n * 核心代码区\r\n **/\r\nvar run = function (params, callback) {\r\n    window.onerror = function (msg, url, line, col, error) {\r\n        // 采用异步的方式,避免阻塞\r\n        setTimeout(function () {\r\n            var _a;\r\n            // 不一定所有浏览器都支持col参数，如果不支持就用window.event来兼容\r\n            col = col || (window.event && window.event.errorCharacter) || 0;\r\n            defaults.url = url;\r\n            defaults.line = \"\" + line;\r\n            defaults.col = \"\" + col;\r\n            if (error && error.stack) {\r\n                // 如果浏览器有堆栈信息，直接使用\r\n                defaults.msg = error.stack.toString();\r\n            }\r\n            else if (arguments.callee) {\r\n                // 尝试通过callee拿堆栈信息\r\n                var ext = [];\r\n                var fn = arguments.callee.caller;\r\n                var floor = 3; // 这里只拿三层堆栈信息\r\n                while (fn && --floor > 0) {\r\n                    ext.push(fn.toString());\r\n                    if (fn === fn.caller) {\r\n                        break; // 如果有环\r\n                    }\r\n                    fn = fn.caller;\r\n                }\r\n                defaults.msg = ext.join(\",\");\r\n            }\r\n            // 合并上报的数据，包括默认上报的数据和自定义上报的数据\r\n            var reportData = __assign(__assign({}, (_a = params.ajax) === null || _a === void 0 ? void 0 : _a.data), defaults);\r\n            if (typeof callback === \"function\") {\r\n                callback(reportData);\r\n            }\r\n            report(reportData, params);\r\n        }, 0);\r\n        return true; // 错误不会console浏览器上,如需要，可将这样注释\r\n    };\r\n};\r\nexport default run;\r\n//# sourceMappingURL=index.js.map","references":["/Users/yangyongming/GitLab/kb-open-source/npm_h5_log/node_modules/dingtalk-robot-sender/index.js"],"map":"{\"version\":3,\"file\":\"index.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/utils/index.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/yangyongming/GitLab/kb-open-source/npm_h5_log/dist/utils/index.d.ts","writeByteOrderMark":false,"text":"declare const defaults: {\r\n    ua: string;\r\n    browser: string;\r\n    os: string;\r\n    osVersion: string;\r\n    errUrl: string;\r\n    msg: string;\r\n    url: string;\r\n    line: string;\r\n    col: string;\r\n    error: string;\r\n};\r\ndeclare type DefaultTypeKeys = typeof defaults;\r\ndeclare type DefaultTypeMap = {\r\n    [K in keyof DefaultTypeKeys]: string;\r\n};\r\nexport interface RunParamsType {\r\n    success?: () => void;\r\n    fail?: () => void;\r\n    ajax?: {\r\n        url: string;\r\n        data: Record<string, any>;\r\n    };\r\n    dd?: {\r\n        accessToken: string;\r\n        secret: string;\r\n    };\r\n}\r\nexport declare type RunParamsFun = (d: DefaultTypeMap) => void;\r\n/**\r\n * 核心代码区\r\n **/\r\ndeclare const run: (params: RunParamsType, callback?: RunParamsFun) => void;\r\nexport default run;\r\n"}}
